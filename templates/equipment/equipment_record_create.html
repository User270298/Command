{% extends 'base.html' %}

{% block title %}Добавление записи | Учет Оборудования{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Добавление записи об оборудовании</h3>
                {% if selected_organization %}
                    <a href="{% url 'organization_detail' selected_organization.id %}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-2"></i> Назад к организации
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="post" id="equipment-form">
                    {% csrf_token %}
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_organization" class="form-label">Организация</label>
                                <select class="form-select" id="id_organization" name="organization" required {% if selected_organization %}disabled{% endif %}>
                                    <option value="" {% if not selected_organization %}selected{% endif %}>Выберите организацию</option>
                                    {% for org in active_organizations %}
                                        <option value="{{ org.id }}" {% if selected_organization and selected_organization.id == org.id %}selected{% endif %}>
                                            {{ org.name }}{% if org.trip.city %} ({{ org.trip.city }}){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if selected_organization %}
                                    <input type="hidden" name="organization" value="{{ selected_organization.id }}">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div id="equipment-fields">
                        <fieldset class="mb-4 p-3 border rounded" id="equipment-1">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Прибор</h5>
                            </div>
                            <input type="hidden" name="equipment-fields" value="1">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="measurement_type_1" class="form-label">Тип измерения</label>
                                    <select class="form-select" id="measurement_type_1" name="measurement_type_1" required>
                                        <option value="" selected>Выберите тип измерения</option>
                                        {% for type in measurement_types %}
                                            <option value="{{ type.id }}">{{ type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <!-- Наименование -->
                                <div class="col-md-6 mb-3">
                                    <label for="name_1" class="form-label">Наименование</label>
                                    <input type="text" class="form-control" id="name_1" name="name_1" autocomplete="off">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="device_type_1" class="form-label">Тип прибора</label>
                                    <input type="text" class="form-control" id="device_type_1" name="device_type_1" autocomplete="off">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="serial_number_1" class="form-label">Номер прибора</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="serial_number_1" name="serial_number_1">
                                        <button type="button" class="btn btn-outline-secondary" id="add-serial-1">+</button>
                                    </div>
                                    <div id="serial-list-1" class="mt-2"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="quantity_1" class="form-label">Количество</label>
                                    <input type="number" class="form-control" id="quantity_1" name="quantity_1" value="1" min="1" required>
                                </div>
                                <!-- Наименование техники -->
                                <div class="col-md-6 mb-3">
                                    <label for="tech_name_1" class="form-label">Наименование техники</label>
                                    <input type="text" class="form-control" id="tech_name_1" name="tech_name_1" autocomplete="off">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="status_1" class="form-label">Статус</label>
                                    <select class="form-select" id="status_1" name="status_1" required>
                                        <option value="годен" selected>Годен</option>
                                        <option value="брак">Брак</option>
                                    </select>
                                </div>
                                <!-- Примечание -->
                                <div class="col-md-6 mb-3">
                                    <label for="notes_1" class="form-label">Примечание <small class="text-muted">(необязательно)</small></label>
                                    <input type="text" class="form-control" id="notes_1" name="notes_1" autocomplete="off">
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    
                    <div class="d-grid gap-2 mb-4">
                        <button type="button" class="btn btn-outline-primary" id="add-equipment-field">
                            <i class="fas fa-plus me-2"></i> Добавить еще один прибор
                        </button>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if selected_organization %}
                            <a href="{% url 'organization_detail' selected_organization.id %}" class="btn btn-outline-secondary me-md-2">Отмена</a>
                        {% else %}
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-md-2">Отмена</a>
                        {% endif %}
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i> Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script>
$(function() {
    $("#name_1").autocomplete({ source: "/equipment/autocomplete-name/" });
    $("#device_type_1").autocomplete({ source: "/equipment/autocomplete-device-type/" });
    $("#tech_name_1").autocomplete({ source: "/equipment/autocomplete-tech-name/" });
    $("#notes_1").autocomplete({ source: "/equipment/autocomplete-notes/" });

    // --- Серийные номера ---
    function setupSerialAdder(equipmentNum) {
        const addBtn = document.getElementById('add-serial-' + equipmentNum);
        const input = document.getElementById('serial_number_' + equipmentNum);
        const listDiv = document.getElementById('serial-list-' + equipmentNum);
        if (!addBtn || !input || !listDiv) return;
        addBtn.addEventListener('click', function() {
            const value = input.value.trim();
            if (value) {
                // Добавить в список
                const span = document.createElement('span');
                span.className = 'badge bg-primary me-1 mb-1';
                span.textContent = value;
                // Кнопка удаления
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-sm btn-link text-danger p-0 ms-1';
                delBtn.innerHTML = '&times;';
                delBtn.onclick = function() { span.remove(); updateHidden(); };
                span.appendChild(delBtn);
                listDiv.appendChild(span);
                input.value = '';
                updateHidden();
            }
        });
        // Скрытое поле для передачи номеров
        let hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'serial_numbers_' + equipmentNum;
        listDiv.parentNode.appendChild(hidden);
        function updateHidden() {
            const nums = Array.from(listDiv.querySelectorAll('span')).map(s => s.childNodes[0].textContent);
            hidden.value = nums.join(',');
        }
    }
    setupSerialAdder(1);
    // Для динамически добавляемых fieldset
    const origAddField = document.getElementById('add-equipment-field').onclick;
    document.getElementById('add-equipment-field').onclick = function() {
        if (origAddField) origAddField.apply(this, arguments);
        setTimeout(function() {
            const count = document.querySelectorAll('#equipment-fields fieldset').length;
            setupSerialAdder(count);
        }, 350);
    };
});
</script>
{% endblock %} 